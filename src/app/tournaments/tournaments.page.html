<ion-header [translucent]="true" class="tournaments-header ion-no-border">
  <ion-toolbar>
    <div class="header-row">
      <div class="header-title">
        <ion-icon name="trophy" color="primary"></ion-icon>
        <span>Comp√©titions</span>
        <!-- üî• INDICATEUR WEBSOCKET -->
        <ion-badge
          *ngIf="websocketService.isWebSocketConnected()"
          color="success"
          class="live-indicator shine-effect"
          [title]="'Connect√© au cluster: ' + getWebSocketStatus().currentCluster"
        >
          <ion-icon name="wifi" size="small"></ion-icon>
          LIVE
        </ion-badge>
        <ion-badge
          *ngIf="!websocketService.isWebSocketConnected()"
          color="danger"
          class="live-indicator"
          [title]="'Cluster test√©: ' + getWebSocketStatus().currentCluster + ' (Tentative ' + getWebSocketStatus().attempts + ')'"
        >
          <ion-icon name="wifi-outline" size="small"></ion-icon>
          HORS LIGNE
        </ion-badge>
      </div>
    </div>
    <div class="subtitle">
      Rejoignez les tournois gaming ‚Ä¢ Mises √† jour temps r√©el
    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding tournaments-content">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Barre de recherche -->
  <ion-searchbar
    *ngIf="competitions.length > 0"
    [(ngModel)]="searchTerm"
    (ionInput)="onSearchChange($event)"
    placeholder="Rechercher un tournoi ou un jeu..."
    show-clear-button="focus"
    debounce="300"
    class="custom-searchbar"
  ></ion-searchbar>

  <!-- Segment pour filtrer par statut -->
  <ion-segment
    mode="ios"
    scrollable
    [(ngModel)]="selectedStatus"
    (ionChange)="selectStatus($event.detail.value?.toString())"
    *ngIf="competitions.length > 0"
  >
    <ion-segment-button *ngFor="let status of statusOptions" [value]="status">
      <ion-label>{{ status }}</ion-label>
    </ion-segment-button>
  </ion-segment>

  <!-- Compteur de r√©sultats avec animation -->
  <div class="results-counter" *ngIf="competitions.length > 0">
    <span class="counter-text"
      >{{ filteredCompetitions.length }} comp√©tition{{
      filteredCompetitions.length > 1 ? 's' : '' }} trouv√©e{{
      filteredCompetitions.length > 1 ? 's' : '' }}</span
    >
    <!-- üî• INDICATEUR DE MISE √Ä JOUR -->
    <ion-spinner
      *ngIf="isUpdating"
      name="dots"
      color="primary"
      class="update-spinner"
    >
    </ion-spinner>
  </div>

  <!-- Skeleton loader pendant le chargement -->
  <ng-container *ngIf="isLoading">
    <ion-card *ngFor="let skel of [1,2]" class="tournament-card">
      <ion-card-header>
        <ion-skeleton-text
          animated
          style="width: 60%; height: 24px"
        ></ion-skeleton-text>
        <ion-skeleton-text
          animated
          style="width: 40%; height: 16px; margin-top: 8px"
        ></ion-skeleton-text>
      </ion-card-header>
      <ion-card-content>
        <ion-skeleton-text
          animated
          style="width: 100%; height: 16px; margin-bottom: 8px"
        ></ion-skeleton-text>
        <ion-skeleton-text
          animated
          style="width: 80%; height: 16px"
        ></ion-skeleton-text>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- Message si aucune comp√©tition -->
  <ng-container *ngIf="competitions && competitions.length === 0">
    <ion-card class="tournament-card">
      <ion-card-content>
        <div style="text-align: center; padding: 24px">
          <ion-icon
            name="sad-outline"
            style="font-size: 48px; color: var(--ion-color-medium)"
          ></ion-icon>
          <h3>Aucune comp√©tition trouv√©e</h3>
          <p>Reviens plus tard pour d√©couvrir de nouveaux tournois !</p>
        </div>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- Message si aucune comp√©tition ne correspond aux filtres -->
  <ng-container
    *ngIf="competitions.length > 0 && filteredCompetitions.length === 0"
  >
    <ion-card class="tournament-card">
      <ion-card-content>
        <div style="text-align: center; padding: 24px">
          <ion-icon
            name="search-outline"
            style="font-size: 48px; color: var(--ion-color-medium)"
          ></ion-icon>
          <h3>Aucun r√©sultat</h3>
          <p>Essayez de modifier vos crit√®res de recherche ou filtres.</p>
          <ion-button fill="clear" color="primary" (click)="resetFilters()">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            R√©initialiser les filtres
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- Liste des comp√©titions avec indicateurs temps r√©el -->
  <ng-container *ngIf="filteredCompetitions && filteredCompetitions.length > 0">
    <ng-container
      *ngFor="let comp of filteredCompetitions; trackBy: trackByCompetitionId"
    >
      <ion-card
        button
        [routerLink]="['/show-tournament', comp.id]"
        routerLinkActive="router-link-active"
        class="tournament-card fade-in"
        [ngClass]="{ 'card-updated shine-effect': comp.justUpdated }"
      >
        <ion-card-header>
          <div class="card-header-content">
            <div class="tournament-info">
              <ion-card-title>
                {{ comp.tournoi?.name }}
                <!-- üî• BADGE TEMPS R√âEL SI MIS √Ä JOUR R√âCEMMENT -->
                <ion-badge
                  *ngIf="comp.justUpdated"
                  color="success"
                  class="updated-badge shine-effect"
                >
                  <ion-icon name="flash" size="small"></ion-icon>
                  MIS √Ä JOUR
                </ion-badge>
                <!-- üî• INDICATEUR DE CONNEXION WEBSOCKET POUR CETTE COMP√âTITION -->
                <ion-badge
                  *ngIf="websocketService.isWebSocketConnected() && !comp.justUpdated"
                  color="primary"
                  class="live-indicator"
                  style="font-size: 8px; margin-left: 4px"
                >
                  <ion-icon name="radio" size="small"></ion-icon>
                  SUIVI
                </ion-badge>
              </ion-card-title>
              <ion-card-subtitle>
                <img
                  [src]="fileSaveOrPreviewService.getAvatarDisplayUrl(comp.game?.logo)"
                  alt="logo"
                  style="
                    width: 24px;
                    height: 24px;
                    vertical-align: middle;
                    margin-right: 6px;
                  "
                />
                {{ comp.game?.name }}
              </ion-card-subtitle>
            </div>
            <ion-chip class="status-chip" [ngClass]="comp.status">
              <ion-icon
                color="light"
                [name]="
                  comp.status === 'upcoming' ? 'calendar-outline' :
                  comp.status === 'ongoing' ? 'play-outline' :
                  comp.status === 'full' ? 'people-outline' :
                  comp.status === 'cancelled' ? 'close-circle-outline' :
                  'checkmark-outline'
                "
              ></ion-icon>
              <ion-label>
                {{ comp.status === 'upcoming' ? '√Ä venir' : comp.status ===
                'ongoing' ? 'En cours' : comp.status === 'full' ? 'Complet' :
                comp.status === 'cancelled' ? 'Annul√©' : 'Termin√©' }}
              </ion-label>
            </ion-chip>
          </div>
        </ion-card-header>

        <ion-card-content>
          <div class="tournament-details">
            <div class="detail-item">
              <ion-icon name="calendar-outline"></ion-icon>
              <div class="detail-content">
                <span class="detail-label">Date D√©but</span>
                <span class="detail-value"
                  >{{ comp.start_date | date:'dd/MM/yyyy' }}</span
                >
              </div>
            </div>
            <div class="detail-item">
              <ion-icon name="people-outline"></ion-icon>
              <div class="detail-content">
                <span class="detail-label">Participants</span>
                <!-- üî• COMPTEUR ANIM√â EN TEMPS R√âEL -->
                <span
                  class="detail-value participant-count"
                  [ngClass]="{ 'count-updated': comp.participantCountUpdated }"
                >
                  {{ comp.current_participants }} / {{ comp.max_participants }}
                  <!-- üî• INDICATEUR DE MISE √Ä JOUR EN TEMPS R√âEL -->
                  <ion-icon
                    *ngIf="comp.participantCountUpdated && websocketService.isWebSocketConnected()"
                    name="trending-up"
                    color="success"
                    size="small"
                    class="update-icon"
                  ></ion-icon>
                </span>
                <!-- üî• BARRE DE PROGRESSION ANIM√âE -->
                <ion-progress-bar
                  [value]="comp.current_participants / comp.max_participants"
                  [color]="comp.status === 'full' ? 'danger' : 'primary'"
                  class="participation-progress"
                  [ngClass]="{ 'progress-updated': comp.participantCountUpdated }"
                >
                </ion-progress-bar>
              </div>
            </div>
          </div>

          <div class="tournament-footer">
            <ng-container *ngIf="comp.is_online">
              <span class="prize">En ligne : Oui</span>
            </ng-container>
            <ng-container *ngIf="!comp.is_online">
              <span class="prize">En ligne : Non</span>
            </ng-container>

            <!-- üî• BOUTONS AVEC √âTATS TEMPS R√âEL -->
            <ng-container
              *ngIf="comp.status === 'upcoming' || comp.status === 'full'"
            >
              <!-- Si l'utilisateur est d√©j√† inscrit -->
              <ion-button
                class="register-btn"
                *ngIf="comp.isUserRegistered"
                [routerLink]="['/show-tournament', comp.id]"
                fill="outline"
                color="medium"
              >
                <ion-icon name="checkmark-circle" slot="start"></ion-icon>
                D√©j√† inscrit
              </ion-button>

              <!-- Si la comp√©tition est pleine -->
              <ion-button
                class="register-btn"
                *ngIf="comp.status === 'full' && !comp.isUserRegistered"
                [routerLink]="['/show-tournament', comp.id]"
                fill="outline"
                color="danger"
                disabled
              >
                <ion-icon name="people" slot="start"></ion-icon>
                Complet
              </ion-button>

              <!-- Si l'utilisateur peut s'inscrire -->
              <ion-button
                class="register-btn"
                *ngIf="comp.status === 'upcoming' && !comp.isUserRegistered"
                [routerLink]="['/show-tournament', comp.id]"
                fill="outline"
                color="primary"
                [ngClass]="{ 'button-pulse': websocketService.isWebSocketConnected() }"
              >
                <ion-icon name="add-circle" slot="start"></ion-icon>
                S'inscrire
                <!-- üî• INDICATEUR TEMPS R√âEL POUR LE BOUTON -->
                <ion-badge
                  *ngIf="websocketService.isWebSocketConnected()"
                  color="success"
                  style="font-size: 8px; margin-left: 4px"
                >
                  LIVE
                </ion-badge>
              </ion-button>
            </ng-container>

            <ng-container *ngIf="comp.status === 'ongoing'">
              <ion-button
                class="register-btn"
                [routerLink]="['/show-tournament', comp.id]"
                fill="outline"
                color="success"
                [ngClass]="{ 'button-pulse': websocketService.isWebSocketConnected() }"
              >
                <ion-icon name="play" slot="start"></ion-icon>
                Voir le live
                <!-- üî• INDICATEUR TEMPS R√âEL POUR LE LIVE -->
                <ion-badge
                  *ngIf="websocketService.isWebSocketConnected()"
                  color="danger"
                  style="font-size: 8px; margin-left: 4px"
                  class="live-indicator"
                >
                  LIVE
                </ion-badge>
              </ion-button>
            </ng-container>
          </div>
        </ion-card-content>
      </ion-card>
    </ng-container>
  </ng-container>

  <!-- üî• TOAST POUR NOTIFICATIONS TEMPS R√âEL -->
  <ion-toast
    *ngIf="showRealtimeToast"
    [isOpen]="showRealtimeToast"
    [message]="realtimeMessage"
    [duration]="4000"
    position="top"
    color="success"
    class="realtime-toast"
    [buttons]="toastButtons"
    (didDismiss)="showRealtimeToast = false"
  >
  </ion-toast>

  <!-- üî• INDICATEUR DE STATUT DE CONNEXION WEBSOCKET EN BAS -->
  <div
    class="websocket-status"
    *ngIf="!websocketService.isWebSocketConnected()"
    style="
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--ion-color-warning);
      color: var(--ion-color-dark);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      animation: slideUp 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    "
  >
    <ion-icon name="wifi-outline" size="small"></ion-icon>
    <span
      >Mode hors ligne - Cluster: {{ getWebSocketStatus().currentCluster }} ({{
      getWebSocketStatus().attempts }}/{{
      getWebSocketStatus().availableClusters.length }})</span
    >
    <ion-button
      size="small"
      fill="clear"
      color="dark"
      (click)="reconnectWebSocket()"
      style="--padding-start: 4px; --padding-end: 4px; height: 24px"
      title="Essayer le cluster suivant"
    >
      <ion-icon name="refresh" size="small"></ion-icon>
    </ion-button>
  </div>
</ion-content>
