<ion-header class="ion-no-border" [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button
        defaultHref="/tabs/tournaments"
        text="Retour"
      ></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Skeleton pendant le chargement -->
  <ng-container *ngIf="loading">
    <div class="skeleton-container">
      <ion-grid>
        <!-- Skeleton pour le titre et status -->
        <ion-card-header>
          <ion-skeleton-text
            animated
            style="width: 70%; height: 28px; margin-bottom: 16px"
          ></ion-skeleton-text>
        </ion-card-header>
        <ion-card-content>
          <div class="card-row">
            <div style="display: flex; align-items: center">
              <ion-skeleton-text
                animated
                style="
                  width: 32px;
                  height: 32px;
                  border-radius: 4px;
                  margin-right: 8px;
                "
              ></ion-skeleton-text>
              <ion-skeleton-text
                animated
                style="width: 120px; height: 20px"
              ></ion-skeleton-text>
            </div>
            <ion-skeleton-text
              animated
              style="width: 80px; height: 32px; border-radius: 16px"
            ></ion-skeleton-text>
          </div>
        </ion-card-content>

        <!-- Skeleton pour les informations du tournoi -->
        <ion-card class="tournament-info-card">
          <ion-card-header>
            <ion-skeleton-text
              animated
              style="width: 60%; height: 24px; margin-bottom: 8px"
            ></ion-skeleton-text>
            <div class="card-row">
              <ion-skeleton-text
                animated
                style="width: 40%; height: 16px"
              ></ion-skeleton-text>
              <ion-skeleton-text
                animated
                style="width: 30%; height: 16px"
              ></ion-skeleton-text>
            </div>
          </ion-card-header>
          <ion-card-content>
            <ion-skeleton-text
              animated
              style="width: 30%; height: 18px; margin-bottom: 12px"
            ></ion-skeleton-text>
            <ion-skeleton-text
              animated
              style="width: 100%; height: 16px; margin-bottom: 8px"
            ></ion-skeleton-text>
            <ion-skeleton-text
              animated
              style="width: 85%; height: 16px; margin-bottom: 16px"
            ></ion-skeleton-text>

            <ion-skeleton-text
              animated
              style="width: 25%; height: 18px; margin-bottom: 12px"
            ></ion-skeleton-text>
            <ion-skeleton-text
              animated
              style="width: 100%; height: 16px; margin-bottom: 6px"
            ></ion-skeleton-text>
            <ion-skeleton-text
              animated
              style="width: 90%; height: 16px; margin-bottom: 6px"
            ></ion-skeleton-text>
            <ion-skeleton-text
              animated
              style="width: 75%; height: 16px; margin-bottom: 16px"
            ></ion-skeleton-text>

            <!-- Skeleton pour le bouton d'inscription -->
            <ion-skeleton-text
              animated
              style="width: 100%; height: 44px; border-radius: 22px"
            ></ion-skeleton-text>
          </ion-card-content>
        </ion-card>

        <!-- Skeleton pour la liste des participants -->
        <ion-card class="participants-card">
          <ion-card-header>
            <ion-skeleton-text
              animated
              style="width: 50%; height: 24px"
            ></ion-skeleton-text>
          </ion-card-header>
          <div class="participants-list">
            <ion-card class="participant-card">
              <!-- Skeleton pour 3 participants -->
              <div class="participant-content" *ngFor="let i of [1,2,3]">
                <ion-skeleton-text
                  animated
                  style="width: 40px; height: 40px; border-radius: 50%"
                ></ion-skeleton-text>
                <div
                  class="participant-info"
                  style="flex: 1; margin-left: 12px"
                >
                  <ion-skeleton-text
                    animated
                    style="width: 60%; height: 20px; margin-bottom: 4px"
                  ></ion-skeleton-text>
                  <ion-skeleton-text
                    animated
                    style="width: 40%; height: 16px"
                  ></ion-skeleton-text>
                </div>
                <ion-skeleton-text
                  animated
                  style="width: 60px; height: 32px; border-radius: 16px"
                ></ion-skeleton-text>
              </div>
            </ion-card>
          </div>
        </ion-card>
      </ion-grid>
    </div>
  </ng-container>

  <!-- Affichage des données réelles -->
  <ng-container *ngIf="!loading && tournament">
    <ion-grid>
      <ion-card class="header-card">
        <ion-card-header>
          <ion-card-title class="tournament-title">
            <ion-icon name="trophy" color="warning"></ion-icon>
            {{ tournament.tournoi?.name }}
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <div class="card-row">
            <p class="game-name">
              <img
                *ngIf="tournament.game?.logo"
                [src]="fileSaveOrPreviewService.getAvatarDisplayUrl(tournament.game?.logo)"
                alt="logo"
                style="
                  width: 28px;
                  height: 28px;
                  vertical-align: middle;
                  margin-right: 8px;
                  border-radius: 6px;
                "
              />
              <ion-icon
                name="game-controller-outline"
                color="primary"
              ></ion-icon>
              {{ tournament.game?.name }}
            </p>
            <ion-chip class="status-chip" [ngClass]="tournament.status">
              <ion-icon
                color="light"
                [name]="tournament.status === 'upcoming' ? 'calendar-outline' : (tournament.status === 'ongoing' ? 'play-outline' : 'checkmark-outline')"
              ></ion-icon>
              <ion-label>
                {{ tournament.status === 'upcoming' ? 'À venir' :
                (tournament.status === 'ongoing' ? 'En cours' : 'Terminé') }}
              </ion-label>
            </ion-chip>
          </div>

          <!-- Participants Count -->
          <div class="participants-count">
            <ion-icon name="people-outline" color="primary"></ion-icon>
            <span class="participants-text">
              <strong>{{ tournament.current_participants }}</strong> /
              <strong>{{ tournament.max_participants }}</strong> participants
            </span>
            <div class="progress-bar">
              <div
                class="progress-fill"
                [style.width.%]="(tournament.current_participants / tournament.max_participants) * 100"
              ></div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Informations du tournoi -->
      <ion-card class="tournament-info-card">
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="trophy" color="warning"></ion-icon>
            Informations du tournoi
          </ion-card-title>
          <ion-card-subtitle>
            <div class="card-row">
              <div class="date-container">
                <div>
                  <ion-icon name="calendar-outline" color="primary"></ion-icon>
                  <strong>Début:</strong> {{ tournament.start_date |
                  date:'dd/MM/yyyy à HH:mm' }}
                </div>
                <div>
                  <ion-icon name="calendar-outline" color="primary"></ion-icon>
                  <strong>Fin:</strong> {{ tournament.end_date |
                  date:'dd/MM/yyyy à HH:mm' }}
                </div>
              </div>
              <div class="tournament-details">
                <span class="mode-info">
                  <ion-icon name="people-outline" color="success"></ion-icon>
                  <strong>Mode:</strong> {{ getGameModeLabel(tournament.mode) }}
                </span>
                <span class="location-info">
                  <ion-icon name="globe-outline" color="tertiary"></ion-icon>
                  <strong>Type:</strong> {{ tournament.is_online ? 'En ligne' :
                  'Présentiel' }}
                </span>
              </div>
            </div>
          </ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="section-with-icon">
            <ion-icon name="document-text-outline" color="primary"></ion-icon>
            <p class="section-title">Description</p>
          </div>
          <ion-text class="ion-text-justify">
            <p>{{ tournament.description }}</p>
          </ion-text>

          <div class="section-with-icon">
            <ion-icon name="trophy-outline" color="warning"></ion-icon>
            <p class="section-title">Récompenses</p>
          </div>
          <ion-text class="ion-text-justify">
            <div class="rewards-container">
              <ng-container *ngFor="let reward of getRewardsArray()">
                <div class="reward-item">
                  <ion-icon name="medal-outline" color="warning"></ion-icon>
                  <span
                    ><strong>{{ reward.position }}:</strong> {{ reward.prize
                    }}</span
                  >
                </div>
              </ng-container>
            </div>
          </ion-text>

          <div class="section-with-icon">
            <ion-icon name="list-outline" color="primary"></ion-icon>
            <p class="section-title">Règles</p>
          </div>
          <ion-text class="ion-text-justify">
            <ul class="rules-list">
              <ng-container *ngFor="let rule of getRulesArray()">
                <li>
                  <ion-icon name="checkmark-outline" color="success"></ion-icon>
                  {{ rule }}
                </li>
              </ng-container>
            </ul>
          </ion-text>

          <!-- Contact Links -->
          <div class="contact-section" *ngIf="getContactLinks().length > 0">
            <p class="section-title">Rejoignez-nous sur nos réseaux sociaux</p>
            <div class="contact-links">
              <ng-container *ngFor="let contact of getContactLinks()">
                <ion-button
                  fill="outline"
                  size="small"
                  [href]="contact.url"
                  target="_blank"
                >
                  <ion-icon
                    [name]="getContactIcon(contact.type)"
                    slot="start"
                  ></ion-icon>
                  {{ contact.type }}
                </ion-button>
              </ng-container>
            </div>
          </div>
          <!-- New team-based registration buttons -->
          <ng-container *ngIf="user && tournament.status === 'upcoming'">
            <!-- User is registered and in a team -->
            <ng-container *ngIf="registrationStatus?.isRegistered">
              <ion-button
                expand="block"
                shape="round"
                color="success"
                disabled
                class="registration-button success-button"
              >
                <ion-icon
                  name="checkmark-circle-outline"
                  slot="start"
                ></ion-icon>
                Inscrit au tournoi
                <ion-icon name="sparkles" slot="end"></ion-icon>
              </ion-button>
            </ng-container>

            <!-- User is not registered -->
            <ng-container
              *ngIf="!registrationStatus?.isRegistered && authenticationService.isAuthenticated()"
            >
              <ion-button
                expand="block"
                shape="round"
                color="primary"
                (click)="createTeam()"
                class="registration-button primary-button"
              >
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                S'inscrire au tournoi
                <ion-icon name="arrow-forward" slot="end"></ion-icon>
              </ion-button>
            </ng-container>
          </ng-container>

          <!-- Handle other tournament statuses -->
          <ng-container *ngIf="tournament.status === 'full'">
            <ion-button
              expand="block"
              shape="round"
              color="danger"
              disabled
              class="registration-button danger-button"
            >
              <ion-icon name="close-circle-outline" slot="start"></ion-icon>
              Tournoi complet
            </ion-button>
          </ng-container>

          <ng-container
            *ngIf="tournament.status !== 'upcoming' && tournament.status !== 'full'"
          >
            <ion-button
              expand="block"
              shape="round"
              color="medium"
              disabled
              class="registration-button medium-button"
            >
              <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
              Les inscriptions sont fermées
            </ion-button>
          </ng-container>

          <!-- If user is not logged in -->
          <ng-container *ngIf="!authenticationService.isAuthenticated()">
            <ion-button
              expand="block"
              shape="round"
              color="primary"
              (click)="login()"
              class="registration-button login-button"
            >
              <ion-icon name="log-in-outline" slot="start"></ion-icon>
              Connectez-vous pour vous inscrire
              <ion-icon name="person-add-outline" slot="end"></ion-icon>
            </ion-button>
          </ng-container>
        </ion-card-content>
      </ion-card>
      <ion-card class="participants-card">
        <ion-card-header>
          <ion-card-title
            ><ion-icon color="success" name="people-outline"></ion-icon> Équipes
            inscrites ({{ tournament.teams ? tournament.teams.length : 0
            }})</ion-card-title
          >
        </ion-card-header>
        <div class="participants-list">
          <ng-container
            *ngIf="tournament.teams && tournament.teams.length > 0; else noParticipants"
          >
            <ion-card
              class="participant-card"
              [ngClass]="{'current-user': isCurrentUserInTeam(team)}"
              *ngFor="let team of tournament.teams"
            >
              <ion-card-header>
                <ion-card-title>
                  <ion-icon name="shield-outline" color="primary"></ion-icon>
                  {{ team.name }}
                </ion-card-title>
                <ion-card-subtitle>
                  <ion-chip
                    [color]="team.status === 'accepted' ? 'success' : 'medium'"
                    size="small"
                  >
                    <ion-icon
                      [name]="team.status === 'accepted' ? 'checkmark-circle' : 'time'"
                    ></ion-icon>
                    <ion-label>
                      {{ team.status === 'accepted' ? 'Acceptée' : team.status
                      }}
                    </ion-label>
                  </ion-chip>
                </ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <div class="team-info">
                  <div class="team-meta">
                    <ion-icon name="calendar-outline" color="medium"></ion-icon>
                    <span
                      >Inscrite le {{ team.created_at | date:'dd/MM/yyyy à
                      HH:mm' }}</span
                    >
                  </div>
                  <div
                    class="team-meta"
                    *ngIf="team.members && team.members.length > 0"
                  >
                    <ion-icon name="person-outline" color="medium"></ion-icon>
                    <span>{{ team.members.length }} membre(s)</span>
                  </div>
                  <div class="team-meta" *ngIf="isCurrentUserInTeam(team)">
                    <ion-icon name="star" color="warning"></ion-icon>
                    <span
                      style="color: var(--ion-color-warning); font-weight: 600"
                      >Votre équipe</span
                    >
                  </div>
                </div>
              </ion-card-content>
            </ion-card>
          </ng-container>
          <ng-template #noParticipants>
            <ion-card class="no-participant-card">
              <ion-card-content>
                <p>Aucune équipe inscrite pour ce tournoi.</p>
              </ion-card-content>
            </ion-card>
          </ng-template>
        </div>
      </ion-card>
    </ion-grid>
  </ng-container>
</ion-content>
